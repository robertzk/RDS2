<!DOCTYPE html>
<html lang="en" class="">
  <head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta name="description" content="A slightly improved serialization format for R that allows for serialization of binary objects (e.g., external pointers to C structures).">

    <title>RDS2 (http://github.com/robertzk/RDS2)</title>

    <link rel="stylesheet" media="all" href="stylesheets/rocco.css" />
    <link rel="stylesheet" media="all" href="stylesheets/github-markdown.css" />

    <script src="assets/highlight.pack.js"></script>
    <script type="text/javascript">
      hljs.initHighlightingOnLoad();
    </script>

    <style type="text/css">
      .header {
        position: fixed;
        top: 0px;
        width: 100%;
        background-color: rgba(0, 0, 0, 0.25);
        padding: 10px;
      }
      
      .header a {
        padding-right: 30px;
      }

      .container {
        margin-top: 40px;
      }

      body {
        padding: 0;
        margin: 0;
      }

      div.code-background {
        float: right;
        position: fixed;
        z-index: -1;
        height: 100%;
        background-color: #f8f8ff;
        width: 60%;
        right: 0px;
      }

      div.section {
        clear: both;
        margin: 0; padding: 0;
      }

      div.code {
        float: right;
        width: 60%;
      }

      code.R {
        font-size: 1.2em;
        line-height: 2em;
        margin-top: 0em;
        margin-bottom: -2em;
        padding-top: 0;
        margin-top: -1em;
      }

      code.R > span.spacer {
        position: relative;
      }

      div.code > pre {
        margin: 0;
        padding-left: 2em;
        margin-top: 0;
        margin-bottom: 0;
      }

      div.markdown {
        padding: 1em;
        padding-top: 0;
        background: #fff;
        float: left;
        width: 35%;
      }
    </style>

  </head>

  <body>
    <div class="header">
      <a href="https://github.com/robertzk/rocco">
        <img id="rocco-logo" src="https://img.shields.io/badge/Generated by rocco_v0.2.1.2-%E2%9C%93-blue.svg"/>
      </a>
    </div>
    <div class="container">

      <div class="code-background"></div>

        <div class="section">
          <div class="markdown markdown-body">
            <h1>RDS2-package.R</h1>

          </div>

          <div class="code">
            <pre>
              <code class="R"><span class="spacer"></span></code>
            </pre>
          </div>
        </div>
        <div class="section">
          <div class="markdown markdown-body">
            
          </div>

          <div class="code">
            <pre>
              <code class="R"><span class="spacer">#' An improvement to serialization in R.
#'
#' RDS2 offers a slightly improved serialization format over R's built-in
#' [RDS](http://cran.r-project.org/web/packages/RDS/index.html) that solves
#' the problem of serializing external pointers (e.g., to non-native C
#' structures).
#'
#' The package overwrites R's built-in \code{\link{readRDS}} and 
#' \code{\link{saveRDS}} functions. If the object being saved or read
#' has an attributes called "RDS2.serialize", it will use this attribute
#' to serialize any normally unserializable content associated with the
#' object.
#'
#' The RDS2.serialize attribute should be a list consisting of a read
#' and write function that transforms the non-native R object into a
#' native R object. For example, it could take C structures attached
#' to the object, serialize them as \code{\link{raw}} objects expressing
#' the binary contents and attach them to the R object during writing,
#' and reverse this process during reading.
#'
#' @name RDS2
#' @docType package
NULL</span></code>
            </pre>
          </div>
        </div>
        <div class="section">
          <div class="markdown markdown-body">
            <h1>serialize.R</h1>

          </div>

          <div class="code">
            <pre>
              <code class="R"><span class="spacer"></span></code>
            </pre>
          </div>
        </div>
        <div class="section">
          <div class="markdown markdown-body">
            
          </div>

          <div class="code">
            <pre>
              <code class="R"><span class="spacer">#' Serialize an R object to a connection.
#'
#' This version of readRDS and saveRDS provides capabilities to define
#' serializers for non-native R objects (such as external pointers to C structures).
#'  
#' The function behaves exactly the same as \code{\link[base]{saveRDS}}
#' for native R objects. However, if the object has an attribute 
#' called "RDS2.serialize", this will be used to serialize the object
#' instead. Specifically, the attribute must be a list with keys
#' \code{"read"} and \code{"write"} which must be functions that
#' transform the object into a vanilla R object.
#'
#' For example, suppose we have an object \code{a <- list(x = 1, y = z)},
#' where \code{z} is an external pointer to a C structure.
#' We could set the "RDS2.serialize" attribute as follows.
#'
#' \code{
#'   attr(a, "RDS2.serialize") <- list(
#'     read  = function(obj) { obj$y <- raw_to_ptr(obj$y); obj },
#'     write = function(obj) { obj$y <- ptr_to_raw(obj$y); obj }
#'  )
#' }
#'
#' Here, \code{raw_to_ptr} and \code{ptr_to_raw} are helper functions
#' that serialize and deserialize the C structure to an R object,
#' such as a \code{\link{raw}} vector.
#'
#' @name saveRDS
#' @note The attribute "RDS2.serialize" will be serialized along with the
#'   object, so you must be careful that the parent environment chain of
#'   helper functions used in the read and write methods do not contain
#'   large objects. In general, it is better to use no helper functions
#'   (i.e., the \code{read} and \code{write} functions should be pure
#'   functions rather than closures, and you should set their
#'   \code{environment(read) <- globalenv()} explicitly.).
#'
#'   The mechanism provided by RDS2 is slightly different than the
#'   \code{refhook} argument to the base \code{\link[base]{readRDS}} and
#'   \code{\link[base]{saveRDS}}, since it encloses the serialization procedure
#'   within the serialized object. This allows for greater portability, since
#'   (if these functions are pure) the consumer of an RDS2-serialized object
#'   need only have the RDS2 package attached, rather than the function or
#'   library the \code{refhook} may be from.
#' @param object ANY. The R object to serialize to a file. This object should
#'   have an attribute with the name "RDS2.serialize" if the RDS2 package
#'   capabilities for serializing and deserializing non-native R objects
#'   wish to be used. It should consist of a list with one or both of the
#'   keys \code{read} and \code{write} that take the object as input
#'   and convert a vanilla-to-non-vanilla and non-vanilla-to-vanilla R
#'   object, respectively. (Here, non-vanilla means it may reference non-native
#'   R objects, such as external pointers to C structures).
#'
#'   If the "RDS2.serialize" attribute has the list element
#'   \code{side_effects = FALSE}, an additional deserialization step will
#'   not be executed during \code{saveRDS}. This can be used to slightly speed
#'   up that function. For example, if \code{saveRDS} is serializing a reference
#'   class object or environment, where the \code{write} function can have 
#'   side effects on the object, we must be careful to undo these effects.
#'   Setting \code{attr(object, "RDS2.serialize")$side_effects = FALSE},
#'   we skip this reversal, if we are confident the serialization procedure
#'   does not affect the object or any of its components.
#' @param ... arguments to pass to \code{\link[base]{saveRDS}} or
#'    \code{\link[base]{saveRDS}}. If the first argument of \code{saveRDS},
#'    that is, the \code{object} parameter, has an attribute called
#'   "RDS2.serialize", special serialization and deserialization will occur
#'   prior to writing to the file.
#' @return For \code{readRDS}, an R object. For \code{saveRDS}, \code{NULL},
#'   invisibly.
#' @export
#' @examples
#' file <- tempfile()
#' native_obj <- list(x = 1)
#' saveRDS(native_obj, file)
#' stopifnot(identical(native_obj, readRDS(file)))
#' 
#' # We do not have any C structures to play with, but we will pretend
#' # by converting the string "pointer" to a raw vector.
#' nonnative_obj <- list(x = 1, y = "pointer")
#' attr(nonnative_obj, "RDS2.serialize") <- list(
#'   read  = function(obj) { obj$y <- rawToChar(obj$y); obj },
#'   write = function(obj) { obj$y <- charToRaw(obj$y); obj }
#' )
#' saveRDS(nonnative_obj, file)
#' without_attributes <- function(obj) { attr(obj, "RDS2.serialize") <- NULL; obj }
#' stopifnot(identical(list(x = 1, y = charToRaw("pointer")),
#'   without_attributes(base::readRDS(file))))
#' stopifnot(all.equal(nonnative_obj, readRDS(file)))
#' # Without RDS2, the vanilla object that was passed through the "write" method
#' # is stored in the file. We cannot load the object correctly unless RDS2
#' # is in the search path, so consumers of this RDS file should be careful.
#'
#' # With RDS, the object is deserialized correctly.
saveRDS <- function(object, ...) {
  serialized_object <- serialize(object)
  return_value <- base::saveRDS(serialized_object, ...)
</span></code>
            </pre>
          </div>
        </div>
        <div class="section">
          <div class="markdown markdown-body">
            <p>Some objects, such as reference class objects, will experience side-effects
(mutation) during serialization. At the expense of computational slowness,
we undo the serialization to revert these side effects.</p>

          </div>

          <div class="code">
            <pre>
              <code class="R"><span class="spacer">  if (has_side_effects(object)) {
    deserialize(serialized_object)
  }

  return_value
}

#' @rdname saveRDS
#' @param file a connection or the name of the file where the R object is saved
#'    to or read from.
#' @export
readRDS <- function(file, ...) {
  raw_object <- base::readRDS(file, ...)
  deserialize(raw_object)
}

#' Serialize or deserialize an R object according to its RDS2 serialization.
#'
#' @name serialize
#' @seealso \code{\link{saveRDS}}
#' @param object ANY. The R object to serialize.
#' @return For serialize, the serialized R object. For deserialize, the
#'   deserialized R object.
#'
#'   The function \code{attr(object, "RDS2.serialize")$write} will be
#'   used to perform the serialization and the 
#'   \code{attr(object, "RDS2.serialize")$read} function will be used
#'   to perform the deserialization.
serialize <- function(object) {
  if (object.size(object) == 0) {
    warning("Size-0 object is being serialized.", call. = TRUE)
    NULL
  } else {
    write_method(object)(object)
  }
}

#' @rdname serialize
deserialize <- function(object) { 
  if (object.size(object) == 0) {
    warning("Size-0 object is being serialized.", call. = TRUE)
    NULL
  } else {
    read_method(object)(object)
  }
}

write_method <- function(object) {
  attr(object, "RDS2.serialize")$write %||% identity
}

read_method <- function(object) {
  attr(object, "RDS2.serialize")$read %||% identity
}

has_side_effects <- function(object) {</span></code>
            </pre>
          </div>
        </div>
        <div class="section">
          <div class="markdown markdown-body">
            <p>If the user specifies that this object&#39;s serialization does
not have side effects on the R object, we can skip the deserialization
step in <code>saveRDS</code>.</p>

          </div>

          <div class="code">
            <pre>
              <code class="R"><span class="spacer">  !identical(attr(object, "RDS2.serialize")$side_effects, FALSE)
}
</span></code>
            </pre>
          </div>
        </div>
        <div class="section">
          <div class="markdown markdown-body">
            <h1>utils.R</h1>

          </div>

          <div class="code">
            <pre>
              <code class="R"><span class="spacer"></span></code>
            </pre>
          </div>
        </div>
        <div class="section">
          <div class="markdown markdown-body">
            
          </div>

          <div class="code">
            <pre>
              <code class="R"><span class="spacer">`%||%` <- function(x, y) if (is.null(x)) y else x</span></code>
            </pre>
          </div>
        </div>
      <div class="section">
      </div>

    </div>
  </body>
</html>
